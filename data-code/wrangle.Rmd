---
title: "wrangle"
author: "Wonjun Choi"
date: "2022-09-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
```

```{r Import Package, results = FALSE}
pacman::p_load(tidyverse, haven, here)
```

```{r}
## load

# working directory is {}/aha-data/ (above data-code)
df_hosp <- tibble()
for (y in 2007:2019){
  if (y == 2007) {
    f <- here("data",'input',paste0('AHA FY ',y),'COMMA','comma.csv')
  } else if (y==2008) {
    f <- here('data','input',paste0('AHA FY ',y),'COMMA','pubas08.csv')
  } else if (y==2009) {
    f <- here('data','input',paste0('AHA FY ',y),'Comma','pubas09.csv')
  } else if (y<=2012) {
    f <- here('data','input',paste0('AHA FY ',y),
              'COMMA', paste0('ASPUB',y-2000,'.csv'))
  } else if (y<=2015) {
        f <- here('data','input',paste0('AHA FY ',y),
              'COMMA', paste0('ASPUB',y-2000,'.CSV'))
  } else {
    f <- here('data','input',paste0('AHA FY ',y),
              paste0('ASPUB',y-2000,'.csv'))
  }
  df_temp <- read.csv(f)
  df_temp <- df_temp %>% select('ID','MNAME') %>% mutate(year=y)
  df_hosp <- rbind(df_hosp, df_temp)
}
df_hosp <- df_hosp %>% group_by(ID) %>% 
  mutate(n = n()) %>% ungroup()
```

```{r}
# df_hosp %>% select(ID) %>% unique()  # n = 7165
```

```{r}
y <-2007
dir_temp <-here('data','temp')
df_reg_add <- read.csv(here(dir_temp,paste0('change_reg_add_',y,'.csv')))
df_reg_del <- read.csv(here(dir_temp,paste0('change_reg_del_',y,'.csv')))
df_nonreg_add <- read.csv(here(dir_temp,paste0('change_nonreg_add_',y,'.csv')))
df_nonreg_del <- read.csv(here(dir_temp,paste0('change_nonreg_del_',y,'.csv')))
```

```{r}
df_reg_add
```
```{r}
#df_hosp %>% filter(ID==6350011)
```



```{r Import data}
dat_cooper <- read_csv(paste0(here(),'/data/cooper-et-al/HC_ext_mergerdata_public.csv'))
```
```{r}
dat_cooper %>% filter(id=='653032B')
```


```{r Import data}
y <- 2007

f <- paste0(here(),'/data/input/AHA FY ',y,'/COMMA/comma.csv')
df_2007 <- read.csv(f)
df_2007 <- df_2007 %>% mutate(year = 2007)

print(nrow(df_2007))
print(dat_cooper %>% filter(year==2007) %>% nrow())
print(dat_cooper %>% filter(year==2008) %>% nrow())
print(dat_cooper %>% filter(year==2006) %>% nrow())
```
```{r}
df_2007 %>% filter(MNAME == 'Mercy Rehabilitation Hospital')
```
```{r}
df_2007
```


```{r select}
df_tmp <- df_2007 %>% select(ID, year, REG,STCD,HOSPN,SYSID, LAT,LONG)
```

```{r}
df_tmp %>% filter(ID == 6740051)
```


```{r check each variable}
for (v in variable.names(df_tmp)){
  print(df_tmp %>% select(v) %>% group_by_(v)%>% summarise(n=n()))
}
```
- HOSPN: not unique
- SYSID(matches to health care system file?): not unique
- SYSNAME: not unique, 2833 NA's
- (LAT,LONG): not unique -> see [lat,long is not unique]

```{r sysid is not unique}
df_tmp1 <- df_tmp %>% group_by(SYSID) %>% summarise(n=n()) %>% right_join(df_tmp, by="SYSID")

df_tmp1 %>% filter(n>=2) %>% select(ID, SYSID, n)

# cross-check with cooper -- not meaningful in this stage...
df_tmp2 <- dat_cooper %>% filter(year==2007)
df_tmp2 <- df_tmp2 %>% group_by(sysid) %>% summarise(n=n()) %>% right_join(df_tmp2, by='sysid')

df_tmp2 %>% filter(n>=2) %>% select(id, sysid, n)

df_tmp1 %>% mutate(id=ID) %>% left_join(df_tmp2, by="id") %>% select(id, SYSID, n.x, n.y)
```
seems cooper et al. somehow pooled sysid==2...?

```{r lat,long is not unique}
df_tmp %>% group_by(LAT,LONG) %>% summarise(n=n()) %>% left_join(df_tmp, by=c("LAT","LONG")) %>% filter(n >=2) %>% select(ID, n, LAT, LONG)
```

```{r}
dat_cooper %>% filter(year==2007) %>% nrow()
```


```{r}
dat_cooper %>% filter(year==2007) %>% select(id) %>% unique()
dat_cooper %>% group_by(sysid) %>% summarise(n_cooper=n()) %>% left_join(dat_cooper, by="sysid") %>% select(id, sysid, n_cooper) %>% mutate(ID = id) %>% left_join(df_tmp, by="ID") %>% select(ID, sysid, n_cooper)
```

```{r}
dat_cooper %>% select("id", "sysid", "id_defunct", "id_parent")
```

```{r}
ll <- unique(df_del$ID)
```

```{r}
df_hosp2 %>% names()
```
```{r}
df_hosp%>%names()
```


```{r}
aha_data %>% filter(readum_Colorado == 1)
aha_data %>% filter(ID='Colorado Springs')
```


# build-year
```{r}
```
```{r}
ddd <- df_nonreg_add %>% mutate(ID = as.character(ID))

dddd <- df_hosp %>% left_join(ddd, 'ID')
```

```{r if register status changed, in the list}
ff <- df_reg_del %>% mutate(ID = as.character(ID))
why <- df_hosp %>% select(ID) %>% inner_join(ff, by='ID')
```

```{r if register status changed, in the list}
ff <- df_nonreg_del %>% mutate(ID = as.character(ID))
hoxy <- df_hosp %>% select(ID) %>% left_join(ff,by='ID') %>% filter(del==1)
```

